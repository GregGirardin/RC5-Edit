<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RC5 Config Editor</title>
<style>

.accordion
{
  border: 2px solid white;
  background-color: #def;
  color: #444;
  padding: 6px;
  text-align: left;
  outline: none;
  font-size: 16px;
  transition: 0.2s;
}

.fixedFont
{
  font-family: monospace;
}

.panel
{
  padding: 0 18px;
  display: none;
  overflow: hidden;
  font-size: 20px;
  background-color: #fee;
  text-align: left;
}

</style>
</head>

<body align="left">
<section>
<div>
<input type='file' class='css_menuButton' id='openConfigAction' style='display:none'>
<button class='css_menuButton' id='openConfigButton' onclick='openConfig();'>Open</button>
<button class='css_menuButton' id='saveConfigButton' onclick='saveConfig();'>Save</button>
<hr>
<div id='fileData'> </div>
</div>
</section>

<script>
var configEditedFlag = false;
var rc5_XML;
var memEntries;

var startModes = [ "Immediate", "Fade In" ];
var stopModes = [ "Immediate", "Fade Out", "Loop End" ];
var dubModes = [ "Overdub", "Replace" ];
var fadeTimes = [ "1/16", "1/8", "1/4", "1/2", "1M", "2M", "3M", "4M" ];

//////////////////////////// //////////////////////////// ////////////////////////////
//////////////////////////// //////////////////////////// ////////////////////////////
window.onload = rc5EditInit;

/////////////// /////////////// /////////////// ///////////////
function rc5EditInit()
{
  document.getElementById( 'openConfigAction' ).addEventListener( 'change', openConfigFile, false );
}

function openConfig()
{
  if( configEditedFlag )
    if( !window.confirm( "Unsaved Edits. Continue?" ) )
      return;

  configEditedFlag = false;
  document.getElementById( 'openConfigAction' ).click(); // this little hack is so we can css the open button
}

function openConfigFile( e )
{
  var file = e.target.files[ 0 ];
  if( !file )
    return;
  if( ( file.name != "MEMORY1.RC0" ) && ( file.name != "MEMORY2.RC0" ) )
    alert( "File should be MEMORY1.RC0" );

  var reader = new FileReader();
  reader.onload = function( e )
  {
    var parser = new DOMParser();
    rc5_XML = parser.parseFromString( e.target.result, "text/xml" );
    memEntries = rc5_XML.getElementsByTagName( "mem" );

    generateConfigHTML();

    document.getElementById( 'openConfigAction' ).value = null;
  }

  reader.readAsText( file );
}

// given an array of strings, find the index in the array that matches 'entry'
function getEntryIx( array, entry )
{
  for( var ix = 0;ix < array.length;ix++ )
    if( array[ ix ] == entry )
      return ix;
  
  return -1;
}

function generateConfigHTML()
{
  var accords;
  var tempHtml = "";

  for( var memLoc = 1;memLoc <= memEntries.length;memLoc++ ) // valid memLoc <1 - 99> 
  {
    var memString;

    if( ( memLoc > 0 ) && ( ( memLoc % 10 ) == 0 ) )
      tempHtml += "<hr>";
  
    memString = memLoc.toString();

    if( memString.length == 1 )
      memString = "0" + memString;

    var labelSuffix = memString;

    memString += ". ";

    var entry = memEntries[ memLoc - 1 ]; // entries are 0 based.

    var elem = entry.getElementsByTagName( "NAME" );
    var loopName = "";

    for( var ix = 0;ix < 12;ix++ )
      loopName += String.fromCharCode( parseInt( elem[ 0 ].childNodes[ 1 + ix * 2 ].innerHTML ) );

    memString += loopName;

    tempHtml += "<button class='accordion' id='accord" + labelSuffix + "'>" + memString + "</button>\n";

    var elem    = entry.getElementsByTagName( "TRACK1" );
    var PlyLvl  = parseInt( elem[ 0 ].childNodes[  3 ].innerHTML );
    var Pan     = parseInt( elem[ 0 ].childNodes[  5 ].innerHTML );
    var One     = parseInt( elem[ 0 ].childNodes[  7 ].innerHTML );
    var StrtMod = parseInt( elem[ 0 ].childNodes[  9 ].innerHTML );
    var StpMod  = parseInt( elem[ 0 ].childNodes[ 11 ].innerHTML );
    var MeasLen = parseInt( elem[ 0 ].childNodes[ 17 ].innerHTML );
    var RecTmp  = parseInt( elem[ 0 ].childNodes[ 21 ].innerHTML );
    var WavLen  = parseInt( elem[ 0 ].childNodes[ 25 ].innerHTML );

    var elem      = entry.getElementsByTagName( "MASTER" );
    var Tempo     = parseInt( elem[ 0 ].childNodes[ 1 ].innerHTML );
    var DubMode   = parseInt( elem[ 0 ].childNodes[ 3 ].innerHTML );
    var FadeTime  = parseInt( elem[ 0 ].childNodes[ 9 ].innerHTML );

    var elem = entry.getElementsByTagName( "RHYTHM" );
    var Beat = parseInt( elem[ 0 ].childNodes[ 13 ].innerHTML );

    tempHtml += "<div class='panel'>\n";
    tempHtml += "Name: <input contenteditable='true' id='sampleNameT" + labelSuffix +
                "' size='6' maxlength='6' value='" + loopName.substring( 0, 6 ) + "'>\n";
    tempHtml += "<input contenteditable='true' id='sampleNameB" + labelSuffix +
                "' size='6' maxlength='6' value='" + loopName.substring( 6, 12 ) + "'><br>\n";
    tempHtml += "PlyLvl: <input type='number' id='samplePlyLvl" + labelSuffix +
                "' size='3' min='0' max='200' value='" + PlyLvl + "'><br>\n";
    tempHtml += "Pan: <input type='number' id='samplePan" + labelSuffix +
                "' min='0' max='100' value='" + Pan + "'><br>\n";

    var c = One ? "checked" : "";
    tempHtml += "One Shot: <input type='checkbox' id='sampleOne" + labelSuffix + "' " + c + "><br>\n";

    // Start mode
    tempHtml += "Start:<select id='sampleStartMode" + labelSuffix + "'>";
    for( i = 0;i < startModes.length;i++ )
    {
      tempHtml += "<option value='" + startModes[ i ] + "' ";
      if( StrtMod == i )
        tempHtml += "selected='selected'";
      tempHtml += ">" + startModes[ i ] + "</option>";
    }
    tempHtml += "</select><br>\n";

    // Stop mode
    tempHtml += "Stop:<select id='sampleStopMode" + labelSuffix + "'>";
    for( i = 0;i < stopModes.length;i++ )
    {
      tempHtml += "<option value='" + stopModes[ i ] + "' ";
      if( StpMod == i )
        tempHtml += "selected='selected'";
      tempHtml += ">" + stopModes[ i ] + "</option>";
    }
    tempHtml += "</select><br>\n";

    // fade time
    tempHtml += "Fade:<select id='sampleFadeTime" + labelSuffix + "'>";
    for( i = 0;i < fadeTimes.length;i++ )
    {
      tempHtml += "<option value='" + fadeTimes[ i ] + "' ";
      if( FadeTime == i )
        tempHtml += "selected='selected'";
      tempHtml += ">" + fadeTimes[ i ] + "</option>";
    }
    tempHtml += "</select><br>\n";

    tempHtml += "Measures: <input type='number' id='sampleMeasLen" + labelSuffix + 
                "' size='4' min='1' max='4096' value='" + MeasLen + "'><br>\n";
    tempHtml += "Recorded Tempo: <input type='number' id='sampleRecTmp" + labelSuffix +
                "' min='20.0' max='300.0' value='" + RecTmp / 10 + "'><br>\n";
    tempHtml += "Samples: <input type='number' id='sampleWavLen" + labelSuffix +
                "' min='512' max='10000000' value='" + WavLen + "'><br>\n";
    tempHtml += "Tempo: <input type='number' id='sampleTempo" + labelSuffix +
                "' min='20.0' max='300.0' value='" + Tempo / 10 + "'><br>\n";
    tempHtml += "<button class='css_menuButton' onclick='convertToAsync(\"" + labelSuffix +
                "\", 0 );'>Async</button>";
    tempHtml += "</div>\n";
  }

  document.getElementById( 'fileData' ).innerHTML = tempHtml;

  accords = document.getElementsByClassName( "accordion" );

  for( var i = 0;i < accords.length;i++ )
  {
    accords[ i ].addEventListener( "click", function() { accordionClick( this ); } );
    accords[ i ].nextElementSibling.addEventListener( "click", function() { this.previousElementSibling.scrollIntoView(); } );
    accords[ i ].accIndex = i;
  }
}

function accordionClick( elem )
{
  var wasOpen = elem.classList.contains( "active" );
  var panel = elem.nextElementSibling;

  if( wasOpen )
  {
    updateAccordionText(); // when we close an accordion update all the accordion names.
    panel.style.display = "none"; 
    elem.classList.remove( "active" );
  }
  else
  {
    panel.style.display = "block";
    elem.classList.add( "active" );
  }

  elem.scrollIntoView();
}

// If a sample is asynchronous, find values to prevent RC5 time stretching artifacts.
function convertToAsync( memString )
{
  var memIndex = parseInt( memString );

  if( !memIndex )
    return;

  var waveLen = document.getElementById( "sampleWavLen" + memString ).value;
  var bpm = document.getElementById( "sampleTempo" + memString ).value;

  var nBeats = parseInt( waveLen * bpm / 2646000 );
  var nBeats4 = nBeats; // beats rounded up to a factor of 4 (4/4 time)
  var mod = nBeats % 4;

  if( mod )
    nBeats4 += 4 - mod;

  var waveLenAdj = parseInt( nBeats4 * 2646000 / bpm );

  elem = document.getElementById( "sampleMeasLen" + memString );
  elem.value = nBeats4 / 4;
  elem = document.getElementById( "sampleRecTmp" + memString );
  elem.value = bpm;
  elem = document.getElementById( "sampleTempo" + memString );
  elem.value = bpm;
  elem = document.getElementById( "sampleWavLen" + memString );
  elem.value = waveLenAdj;
}

// Given an DOM element that has in int value, 
// constrain the value
// update the DOM element
// return a string of its value.
function constrainValue( elemId, min, max, factor=1 )
{
  var value = document.getElementById( elemId ).value;

  if( value < min )
    value = min;
  else if( value > max )
    value = max;

  document.getElementById( elemId ).value = value;

  value *= factor; // Provide for tempo which is stored in tenths.
  value = parseInt( value );  
  return value.toString();
}

function updateAccordionText()
{
  for( var memLoc = 1;memLoc <= memEntries.length;memLoc++ ) // valid memLoc < 1 - 99 > 
  {
    var labelSuffix = memLoc.toString();
    if( labelSuffix.length == 1 )
      labelSuffix = "0" + labelSuffix;

    var entry = memEntries[ memLoc - 1 ]; // entries are 0 based.

    var elem = entry.getElementsByTagName( "NAME" );
    var docElem = document.getElementById( "sampleNameT" + labelSuffix );
    var nameString = ( docElem.value.toString() + "      " ).substring( 0, 6 );
    var docElem = document.getElementById( "sampleNameB" + labelSuffix );
    nameString += docElem.value.toString() + "      ".substring( 0, 12 ); // pad with spaces.

    docElem = document.getElementById( "accord" + labelSuffix ); // update the accordion text.
    docElem.innerText = labelSuffix + ". " + nameString;

    docElem = document.getElementById( "accord" + labelSuffix ); // update the accordion text.
    docElem.innerText = labelSuffix + ". " + nameString;

    for( var ix = 0;ix < 12;ix++ )
    {
      var charValue = nameString.charCodeAt( ix );
      elem[ 0 ].childNodes[ 1 + ix * 2 ].innerHTML = charValue.toString();
    }
  }
}

function saveConfig()
{
  // apply all html elements to the XLM
  updateAccordionText();

  for( var memLoc = 1;memLoc <= memEntries.length;memLoc++ ) // valid memLoc < 1 - 99 > 
  {
    var labelSuffix = memLoc.toString();
    if( labelSuffix.length == 1 )
      labelSuffix = "0" + labelSuffix;

    var entry = memEntries[ memLoc - 1 ]; // entries are 0 based.

    elem = entry.getElementsByTagName( "TRACK1" );
    elem[ 0 ].childNodes[ 3 ].innerHTML = constrainValue( "samplePlyLvl" + labelSuffix, 0, 200 );
    elem[ 0 ].childNodes[ 5 ].innerHTML = constrainValue( "samplePan" + labelSuffix, 0, 100 );
    docElem = document.getElementById( "sampleOne" + labelSuffix );
    elem[ 0 ].childNodes[ 7 ].innerHTML = ( docElem.value.toString() == "on" ) ? "1" : "0";

    docElem = document.getElementById( "sampleStartMode" + labelSuffix );
    elem[ 0 ].childNodes[ 9 ].innerHTML = getEntryIx( startModes, docElem.value.toString() ).toString();
    docElem = document.getElementById( "sampleStopMode" + labelSuffix );
    elem[ 0 ].childNodes[ 11 ].innerHTML = getEntryIx( stopModes, docElem.value.toString() ).toString();

    elem[ 0 ].childNodes[ 17 ].innerHTML = constrainValue( "sampleMeasLen" + labelSuffix, 1, 4096 );
    elem[ 0 ].childNodes[ 21 ].innerHTML = constrainValue( "sampleRecTmp" + labelSuffix, 20, 300, 10 );
    elem[ 0 ].childNodes[ 25 ].innerHTML = constrainValue( "sampleWavLen" + labelSuffix, 0, 64 * 1024 * 1024 );

    elem = entry.getElementsByTagName( "MASTER" );
    docElem = document.getElementById( "sampleTempo" + labelSuffix );
    elem[ 0 ].childNodes[ 1 ].innerHTML = constrainValue( "sampleTempo" + labelSuffix, 20, 300, 10 );
    
    docElem = document.getElementById( "sampleFadeTime" + labelSuffix );
    elem[ 0 ].childNodes[ 9 ].innerHTML = getEntryIx( fadeTimes, docElem.value.toString() ).toString();

    elem = entry.getElementsByTagName( "RHYTHM" );
    elem[ 0 ].childNodes[ 13 ].innerHTML = "2"; // 4/4
  }

  // save the XLM file
  const a = document.createElement( 'a' );

  var serializer = new XMLSerializer();
  var xmlString = serializer.serializeToString( rc5_XML );

  const file = new Blob( [ xmlString ], { type: 'text/plain' } );
  
  a.href = URL.createObjectURL( file );
  a.download = "MEMORY1.RC0";
  a.click();
  URL.revokeObjectURL( a.href );
}

</script>
</body>
</html>